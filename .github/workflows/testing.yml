name: Behavior Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:

jobs:
  behavior-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file
      run: |
        cat > .env << EOF
        PORT=8080
        APP_ENV=test
        DB_HOST=psql_bp
        DB_PORT=5432
        DB_DATABASE=test
        DB_USERNAME=test
        DB_PASSWORD=test
        DB_SCHEMA=public

        # AWS Configuration (dummy for LocalStack)
        AWS_ACCESS_KEY_ID=test
        AWS_SECRET_ACCESS_KEY=test
        AWS_REGION=us-east-1
        SNS_TOPIC_ARN=arn:aws:sns:us-east-1:000000000000:OrderCreatedTopic
        EOF

    - name: Build and run tests
      run: |
        echo "Starting services..."
        docker compose up --build -d psql_bp localstack app
        echo "Waiting for database..."
        docker compose run --rm test bash -c "until pg_isready -h psql_bp -U test -d test; do echo 'Waiting for db...'; sleep 2; done"
        echo "Waiting for app..."
        docker compose run --rm test bash -c "until curl -f http://app:8080/products > /dev/null 2>&1; do echo 'Waiting for app...'; sleep 2; done"
        echo "Running tests..."
        docker compose run --rm test
